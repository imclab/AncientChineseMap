<!DOCTYPE html>
<html>
    <head>
        <title>Polygon World</title>
        <style type="text/css">
          html { height: 100% }
          body { height: 100%; margin: 0px; padding: 0px }
          #map_canvas { height: 100% }
          #status { color: #FF0000; position:fixed; top:15px; left:105px; z-index:200;}
        </style>
		
		<link rel="stylesheet" type="text/css" href="css/style.css" />
        <script type="text/javascript" src="js/libs/Stats.js"></script> 
        <script type="text/javascript" src="js/libs/webgl-utils.js"></script> 
        <script type="text/javascript" src="js/libs/glMatrix-0.9.5.min.js"></script> 
        <script type="text/javascript" src="js/libs/webgl-debug.js"></script> 
        <script type="text/javascript" src="js/libs/dat.gui.min.js"></script> 
        <script type="text/javascript" src="js/bongiovi/Scheduler.js"></script> 
        <script type="text/javascript" src="js/bongiovi/SimpleCamera.js"></script> 
        <script type="text/javascript" src="js/bongiovi/HoverCamera.js"></script> 
        <script type="text/javascript" src="js/bongiovi/ProjectionPerspectiveMatrix.js"></script> 
        <script type="text/javascript" src="js/bongiovi/GLModelShader.js"></script> 
        <script type="text/javascript" src="js/bongiovi/GLModel.js"></script> 
        <script type="text/javascript" src="js/bongiovi/GLTexture.js"></script> 
        <script type="text/javascript" src="js/bongiovi/GLTextureFilter.js"></script> 
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false&language=en"></script>
        <script type="text/javascript" src="js/views/ViewMountain.js"></script>
        <script type="text/javascript" src="js/views/ViewDepthMap.js"></script>
        <script type="text/javascript" src="js/views/ViewFinal.js"></script>
        <script type="text/javascript" src="js/Index.js"></script>


        <script id="shader-vs" type="x-shader/x-vertex">
            attribute vec3 aVertexPosition;
            attribute vec3 aVertexNormal;
            attribute vec2 aTextureCoord;

            uniform mat4 uMVMatrix;
            uniform mat4 uPMatrix;
            uniform mat3 uNMatrix;

            uniform vec3 uAmbientColor;

            uniform vec3 uLightingDirection0;
            uniform vec3 uDirectionalColor0;
			uniform float lightWeight0;
			
            uniform vec3 uLightingDirection1;
            uniform vec3 uDirectionalColor1;
			uniform float lightWeight1;
			
            uniform vec3 uLightingDirection2;
            uniform vec3 uDirectionalColor2;
			uniform float lightWeight2;
			
            varying vec2 vTextureCoord;
            varying vec3 vLightWeighting;
            varying vec4 vPos;

            void main(void) {
				vec4 pos = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
                gl_Position = pos;
                vPos = vec4(aVertexPosition, 1.0);
                vTextureCoord = aTextureCoord;

                vec3 transformedNormal = uNMatrix * aVertexNormal;
				// transformedNormal = normalize(transformedNormal);
				
                float directionalLightWeighting0 = max(dot(aVertexNormal, uLightingDirection0), 0.0);
                vec3 vLightWeighting0 = (uAmbientColor + uDirectionalColor0 * directionalLightWeighting0) * lightWeight0;
				
                float directionalLightWeighting1 = max(dot(aVertexNormal, uLightingDirection1), 0.0);
                vec3 vLightWeighting1 = (uAmbientColor + uDirectionalColor1 * directionalLightWeighting1) * lightWeight1;
				
                float directionalLightWeighting2 = max(dot(aVertexNormal, uLightingDirection2), 0.0);
                vec3 vLightWeighting2 = (uAmbientColor + uDirectionalColor2 * directionalLightWeighting2) * lightWeight2;
				
				vLightWeighting = vLightWeighting0+vLightWeighting1+vLightWeighting2;
            }
        </script>

        <script id="shader-fs" type="x-shader/x-fragment">
            precision mediump float;

            varying vec2 vTextureCoord;
            varying vec3 vLightWeighting;
			varying vec4 vPos;

            uniform sampler2D uSampler0;


            void main(void) {
                vec4 textureColor = texture2D(uSampler0, vec2(vTextureCoord.s, vTextureCoord.t));
				vec4 color = vec4(textureColor.rgb * vLightWeighting, textureColor.a);
				// if(vPos.y < 0.1) color.rgb*= vec3(1.0, .5, 0.0);
                gl_FragColor = color;
            }
        </script>

        <script id="shader-fs-mix" type="x-shader/x-fragment">
            precision mediump float;

            varying vec2 vTextureCoord;

            uniform sampler2D uSampler0;
            uniform sampler2D uSampler1;
            uniform sampler2D uSampler2;


            void main(void) {
                vec4 org = texture2D(uSampler0, vec2(vTextureCoord.s, vTextureCoord.t));
                vec4 blur = texture2D(uSampler1, vec2(vTextureCoord.s, vTextureCoord.t));
                vec4 map = texture2D(uSampler2, vec2(vTextureCoord.s, vTextureCoord.t));
                float offset = map.r;
                // gl_FragColor = org * ( 1.0 - offset) + blur * offset;
                gl_FragColor = blur;
            }
        </script>


        <script id="shader-fs-depth-map" type="x-shader/x-fragment">
            precision mediump float;

            varying vec4 vPosition;

            void main(void) {
                float z  = vPosition.z/5000.0;
                gl_FragColor = vec4(z, z, z, 1.0);
            }
        </script>



        <script id="shader-vs-depth-map" type="x-shader/x-vertex">
            attribute vec3 aVertexPosition;
            attribute vec2 aTextureCoord;

            uniform mat4 uMVMatrix;
            uniform mat4 uPMatrix;

            varying vec4 vPosition;

            void main(void) {
                vec2 coord = aTextureCoord;
                vec4 pos = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
                gl_Position = pos;
                vPosition = pos;
            }
        </script>
        
        <script id="shader-vs-otho" type="x-shader/x-vertex">
            attribute vec3 aVertexPosition;
            attribute vec2 aTextureCoord;

            uniform mat4 uMVMatrix;
            uniform mat4 uPMatrix;

            varying vec2 vTextureCoord;

            void main(void) {
                gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
                vTextureCoord = aTextureCoord;
            }
        </script>
		
        <script id="shader-fs-otho" type="x-shader/x-fragment">
            precision mediump float;

            varying vec2 vTextureCoord;
            uniform sampler2D uSampler0;

            void main(void) {
                gl_FragColor = texture2D(uSampler0, vec2(vTextureCoord.s, vTextureCoord.t));
            }
        </script>

        <script id="shader-fs-hblur" type="x-shader/x-fragment">
            // for Test 03
            precision mediump float;

            varying vec2 vTextureCoord;

            uniform sampler2D uSampler0;
            uniform float h;

            void main(void) {
                vec4 sum = vec4( 0.0 );
                vec2 vUv = vTextureCoord;
                sum += texture2D( uSampler0, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.05;
                sum += texture2D( uSampler0, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.09;
                sum += texture2D( uSampler0, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12;
                sum += texture2D( uSampler0, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.15;
                sum += texture2D( uSampler0, vec2( vUv.x,           vUv.y ) ) * 0.18;
                sum += texture2D( uSampler0, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.15;
                sum += texture2D( uSampler0, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12;
                sum += texture2D( uSampler0, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.09;
                sum += texture2D( uSampler0, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.05;

                gl_FragColor = sum;
            }
        </script>

        <script id="shader-fs-vblur" type="x-shader/x-fragment">
            precision mediump float;

            varying vec2 vTextureCoord;

            uniform sampler2D uSampler;
            uniform float v;

            void main(void) {
                vec4 sum = vec4( 0.0 );
                vec2 vUv = vTextureCoord;
                sum += texture2D( uSampler, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.05;
                sum += texture2D( uSampler, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.09;
                sum += texture2D( uSampler, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12;
                sum += texture2D( uSampler, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.15;
                sum += texture2D( uSampler, vec2( vUv.x, vUv.y           ) ) * 0.18;
                sum += texture2D( uSampler, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.15;
                sum += texture2D( uSampler, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12;
                sum += texture2D( uSampler, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.09;
                sum += texture2D( uSampler, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.05;

                gl_FragColor = sum;
            }
        </script>


         <script id="shader-fs-edgeblur" type="x-shader/x-fragment">
            precision mediump float;

            varying vec2 vTextureCoord;

            uniform sampler2D uSampler0;
            uniform sampler2D uSampler1;

            void main(void) {
                vec4 colorOrg = texture2D(uSampler1, vTextureCoord);
                vec4 colorBlur = texture2D(uSampler0, vTextureCoord);
                vec2 center = vec2(.5, .5);
                float maxLeng = length(center);
                float leng = length(vTextureCoord - center);
                float offset = 1.0 - leng / maxLeng;
                offset = pow(offset, 3.0);
                vec4 colorEdgeBlur = colorOrg * offset + colorBlur * (1.0-offset);
                // colorEdgeBlur *= offset;

                gl_FragColor = colorEdgeBlur;
            }
        </script>


        <script>
			var polygon;
		
            function init(){
                canvasGL = document.createElement("canvas");
                canvasGL.id = "canvasGL";
                canvasGL.width = window.innerWidth/2;
                canvasGL.height = window.innerHeight;
                canvasGL.style.position = "absolute";
                canvasGL.style.zIndex = "0";
                canvasGL.style.left = window.innerWidth/2 + "px";

                gl = canvasGL.getContext("experimental-webgl");
                gl.viewportWidth = window.innerWidth/2;
                gl.viewportHeight = window.innerHeight;
                document.body.appendChild(canvasGL);

                var styles = [
                  {
                    "stylers": [
                      { "saturation": -100 },
                      { "lightness": 1 }
                    ]
                  },{
                    "featureType": "poi",
                    "stylers": [
                      { "visibility": "off" }
                    ]
                  },{
                    "featureType": "administrative",
                    "stylers": [
                      { "visibility": "off" }
                    ]
                  },{
                    "featureType": "landscape",
                    "stylers": [
                      { "visibility": "off" }
                    ]
                  },{
                    "featureType": "road.local",
                    "stylers": [
                      { "visibility": "simplified" }
                    ]
                  },{
                    "featureType": "road.arterial",
                    "stylers": [
                      { "visibility": "simplified" }
                    ]
                  },{
                    "featureType": "transit.station",
                    "stylers": [
                      { "weight": 5.1 }
                    ]
                  },{
                    "featureType": "transit.station",
                    "stylers": [
                      { "gamma": 0.01 }
                    ]
                  },{
                  }
                ]

                var latlng = new google.maps.LatLng(24.209394675097073, 120.673828125);

                var styledMap = new google.maps.StyledMapType(styles,   {name: "Styled Map"});  

                var myOptions = {
                    zoom: 9,   
                    center: latlng,
                    mapTypeControlOptions: {
                        mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
                    }
                };

                map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
                map.mapTypes.set('map_style', styledMap);
                map.setMapTypeId('map_style');
				
                var imgBG = new Image();
                imgBG.onload = function(e) {
                    textureBG = new GLTexture(gl, imgBG);
                }
                imgBG.src = "images/bg.jpg";
				
                var img = new Image();
                img.onload = function(e) {
                    texture = new GLTexture(gl, img);
					onLoaded();
                }
                img.src = "images/whitebg.jpg";


                var imgBertrand = new Image();
                imgBertrand.src = "images/bertrand.png";
                imgBertrand.id = "img_bertrand";
                document.body.appendChild(imgBertrand)
            }
			
			function onLoaded() {
				scheduler = new Scheduler();
                gui = new dat.GUI();
				polygon = new Index(map, gl).init();
				
				gui.addColor(polygon.viewMountain, 'ambientColor');
				var f1 = gui.addFolder('Light0');
				f1.add(polygon.viewMountain, 'light0X', -1.0, 1.0);
				f1.add(polygon.viewMountain, 'light0Y', -1.0, 1.0);
				f1.add(polygon.viewMountain, 'light0Z', -1.0, 1.0);
				f1.add(polygon.viewMountain, 'lightWeight0', 0.0, 3.0);
				f1.addColor(polygon.viewMountain, 'lightColor0');
				f1.open();
				
				var f2 = gui.addFolder('Light1');
				f2.add(polygon.viewMountain, 'light1X', -1.0, 1.0);
				f2.add(polygon.viewMountain, 'light1Y', -1.0, 1.0);
				f2.add(polygon.viewMountain, 'light1Z', -1.0, 1.0);
				f2.add(polygon.viewMountain, 'lightWeight1', 0.0, 3.0);
				f2.addColor(polygon.viewMountain, 'lightColor1');
				f2.open();
				
				var f3 = gui.addFolder('Light2');
				f3.add(polygon.viewMountain, 'light2X', -1.0, 1.0);
				f3.add(polygon.viewMountain, 'light2Y', -1.0, 1.0);
				f3.add(polygon.viewMountain, 'light2Z', -1.0, 1.0);
				f3.add(polygon.viewMountain, 'lightWeight2', 0.0, 3.0);
				f3.addColor(polygon.viewMountain, 'lightColor2');
				f3.open();
				
				gui.add(polygon.viewMountain, 'apply');
			}
        </script>
    </head>
        

    <body onload="init()">
        <div id="map_canvas" style="width:50%; height:100%; z-index:1; position:absolute;"></div>
        <div id="info">
            Click to choose 2 locations on the map to see the terrain.
        </div>
    </body>
</html>