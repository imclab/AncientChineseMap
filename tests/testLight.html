<!DOCTYPE html>
<html>
    <head>
        <title>Geolocation and elevation test</title>
        <style type="text/css">
          html { height: 100% }
          body { height: 100%; margin: 0px; padding: 0px }
          #map_canvas { height: 100% }
          #status { color: #FF0000; position:fixed; top:15px; left:105px; z-index:200;}
        </style>
		
        <script type="text/javascript" src="../js/libs/Stats.js"></script> 
        <script type="text/javascript" src="../js/libs/webgl-utils.js"></script> 
        <script type="text/javascript" src="../js/libs/glMatrix-0.9.5.min.js"></script> 
        <script type="text/javascript" src="../js/libs/webgl-debug.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/SimpleCamera.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/HoverCamera.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/ProjectionPerspectiveMatrix.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/GLModelShader.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/GLModel.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/GLTexture.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/GLTextureFilter.js"></script> 
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false&language=en"></script>


        <script id="shader-vs" type="x-shader/x-vertex">
            attribute vec3 aVertexPosition;
            attribute vec3 aVertexNormal;
            attribute vec2 aTextureCoord;

            uniform mat4 uMVMatrix;
            uniform mat4 uPMatrix;
            uniform mat3 uNMatrix;

            uniform vec3 uAmbientColor;

            uniform vec3 uLightingDirection;
            uniform vec3 uDirectionalColor;

            varying vec2 vTextureCoord;
            varying vec3 vLightWeighting;

            void main(void) {
                gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
                vTextureCoord = aTextureCoord;

                vec3 transformedNormal = uNMatrix * aVertexNormal;
                float directionalLightWeighting = max(dot(transformedNormal, uLightingDirection), 0.0);
                vLightWeighting = uAmbientColor + uDirectionalColor * directionalLightWeighting;
            }
        </script>

        <script id="shader-fs" type="x-shader/x-fragment">
            precision mediump float;

            varying vec2 vTextureCoord;
            varying vec3 vLightWeighting;

            uniform sampler2D uSampler0;


            void main(void) {
                vec4 textureColor = texture2D(uSampler0, vec2(vTextureCoord.s, vTextureCoord.t));
                gl_FragColor = vec4(textureColor.rgb * vLightWeighting, textureColor.a);
            }
        </script>


        <script>
            window.requestAnimFrame = (function(){
                return  window.requestAnimationFrame       || 
                window.webkitRequestAnimationFrame || 
                window.mozRequestAnimationFrame    || 
                window.oRequestAnimationFrame      || 
                window.msRequestAnimationFrame     || 
                function( callback ){
                window.setTimeout(callback, 1000 / 60);
                };
            })();

            function init() {
                console.log( "Init " );
                img = new Image();
                img.onload = function(e) {  _onImageLoaded();   }
                img.src = "images/whitebg.jpg";
            }


            function _onImageLoaded(e) {
                canvasGL = document.createElement("canvas");
                canvasGL.id = "canvasGL";
                canvasGL.width = window.innerWidth;
                canvasGL.height = window.innerHeight;
                canvasGL.style.position = "absolute";
                canvasGL.style.zIndex = "0";

                gl = canvasGL.getContext("experimental-webgl");
                gl.viewportWidth = window.innerWidth;
                gl.viewportHeight = window.innerHeight;
                document.body.appendChild(canvasGL);

                texture = new GLTexture(gl, img);

                model = new bongiovi.GLModel(gl, 24);
                shader = new bongiovi.GLModelShader(this.gl, "shader-vs", "shader-fs");
                shader.setParameter("uAmbientColor", "uniform3fv", [.2, .2, .2]);
                shader.setParameter("uDirectionalColor", "uniform3fv", [1, 0, 0]);

                // gl.uniformMatrix3fv(shaderProgram.nMatrixUniform, false, normalMatrix);

                model.setTexture(0, texture);
                model.setAttribute(0, "aVertexNormal", 3);

                var size = 100;
                model.updateVertex(0, -size, -size, size);
                model.updateVertex(1,  size, -size, size);
                model.updateVertex(2,  size,  size, size);
                model.updateVertex(3, -size,  size, size);

                model.updateVertex(4, -size, -size, -size);
                model.updateVertex(5, -size,  size, -size);
                model.updateVertex(6,  size,  size, -size);
                model.updateVertex(7,  size, -size, -size);

                model.updateVertex(8, -size,  size, -size);
                model.updateVertex(9, -size,  size,  size);
                model.updateVertex(10,  size,  size,  size);
                model.updateVertex(11,  size,  size, -size);

                model.updateVertex(12, -size, -size, -size);
                model.updateVertex(13,  size, -size, -size);
                model.updateVertex(14,  size, -size,  size);
                model.updateVertex(15, -size, -size,  size);

                model.updateVertex(16,  size, -size, -size);
                model.updateVertex(17,  size,  size, -size);
                model.updateVertex(18,  size,  size,  size);
                model.updateVertex(19,  size, -size,  size);

                model.updateVertex(20, -size, -size, -size);
                model.updateVertex(21, -size, -size,  size);
                model.updateVertex(22, -size,  size,  size);
                model.updateVertex(23, -size,  size, -size);


                model.updateTextCoord(0, 0, 0);
                model.updateTextCoord(1, 1, 0);
                model.updateTextCoord(2, 1, 1);
                model.updateTextCoord(3, 0, 1);

                model.updateTextCoord(4, 0, 0);
                model.updateTextCoord(5, 1, 0);
                model.updateTextCoord(6, 1, 1);
                model.updateTextCoord(7, 0, 1);

                model.updateTextCoord(8, 0, 0);
                model.updateTextCoord(9, 1, 0);
                model.updateTextCoord(10, 1, 1);
                model.updateTextCoord(11, 0, 1);

                model.updateTextCoord(12, 0, 0);
                model.updateTextCoord(13, 1, 0);
                model.updateTextCoord(14, 1, 1);
                model.updateTextCoord(15, 0, 1);

                model.updateTextCoord(16, 0, 0);
                model.updateTextCoord(17, 1, 0);
                model.updateTextCoord(18, 1, 1);
                model.updateTextCoord(19, 0, 1);

                model.updateTextCoord(20, 0, 0);
                model.updateTextCoord(21, 1, 0);
                model.updateTextCoord(22, 1, 1);
                model.updateTextCoord(23, 0, 1);


                this.model.updateAttribute(0, 0,   [0, 0, 1]);
                this.model.updateAttribute(0, 1,   [0, 0, 1]);
                this.model.updateAttribute(0, 2,   [0, 0, 1]);
                this.model.updateAttribute(0, 3,   [0, 0, 1]);

                this.model.updateAttribute(0, 4,   [0, 0, -1]);
                this.model.updateAttribute(0, 5,   [0, 0, -1]);
                this.model.updateAttribute(0, 6,   [0, 0, -1]);
                this.model.updateAttribute(0, 7,   [0, 0, -1]);

                this.model.updateAttribute(0, 8,   [0, 1, 0]);
                this.model.updateAttribute(0, 9,   [0, 1, 0]);
                this.model.updateAttribute(0, 10,   [0, 1, 0]);
                this.model.updateAttribute(0, 11,   [0, 1, 0]);

                this.model.updateAttribute(0, 12,   [0, -1, 0]);
                this.model.updateAttribute(0, 13,   [0, -1, 0]);
                this.model.updateAttribute(0, 14,   [0, -1, 0]);
                this.model.updateAttribute(0, 15,   [0, -1, 0]);

                this.model.updateAttribute(0, 16,   [1, 0, 0]);
                this.model.updateAttribute(0, 17,   [1, 0, 0]);
                this.model.updateAttribute(0, 18,   [1, 0, 0]);
                this.model.updateAttribute(0, 19,   [1, 0, 0]);

                this.model.updateAttribute(0, 20,   [-1, 0, 0]);
                this.model.updateAttribute(0, 21,   [-1, 0, 0]);
                this.model.updateAttribute(0, 22,   [-1, 0, 0]);
                this.model.updateAttribute(0, 23,   [-1, 0, 0]);

                model.generateBuffer();

                var W = canvasGL.width;
                var H = canvasGL.height;
                projection = new bongiovi.ProjectionPerspectiveMatrix();
                projection.perspective(45, W/H, .1, 1000);
                camera = new bongiovi.HoverCamera().init(500);

                loop();
            }


            function loop() {
                requestAnimFrame(loop);
                render();
            }


            function render() {
                gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.enable(gl.BLEND);
                gl.enable(gl.DEPTH_TEST);

                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

                var lightingDirection = [0, 0, -1];
                var adjustedLD = vec3.create();
                vec3.normalize(lightingDirection, adjustedLD);
                vec3.scale(adjustedLD, -1);

                var normalMatrix = mat3.create();
                mat4.toInverseMat3(camera.update(), normalMatrix);
                mat3.transpose(normalMatrix);
                shader.setParameter("uNMatrix", "uniformMatrix3fv", normalMatrix);

                shader.setParameter("uLightingDirection", "uniform3fv", adjustedLD);


                model.render(shader, camera.update(), projection.matrix);
            }
        </script>
    
    </head>
        

    <body onload="init()">
        <!-- <div id="map_canvas" style="width:50%; height:100%; z-index:1; position:absolute;"></div> -->
    </body>
</html>