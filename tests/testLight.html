<!DOCTYPE html>
<html>
    <head>
        <title>Geolocation and elevation test</title>
        <style type="text/css">
          html { height: 100% }
          body { height: 100%; margin: 0px; padding: 0px }
          #map_canvas { height: 100% }
          #status { color: #FF0000; position:fixed; top:15px; left:105px; z-index:200;}
        </style>
		
        <script type="text/javascript" src="../js/libs/Stats.js"></script> 
        <script type="text/javascript" src="../js/libs/webgl-utils.js"></script> 
        <script type="text/javascript" src="../js/libs/glMatrix-0.9.5.min.js"></script> 
        <script type="text/javascript" src="../js/libs/webgl-debug.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/SimpleCamera.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/HoverCamera.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/ProjectionPerspectiveMatrix.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/GLModelShader.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/GLModel.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/GLTexture.js"></script> 
        <script type="text/javascript" src="../js/bongiovi/GLTextureFilter.js"></script> 
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false&language=en"></script>


        <script id="shader-vs" type="x-shader/x-vertex">
            attribute vec3 aVertexPosition;
            attribute vec2 aTextureCoord;
            attribute vec3 aNormal;

            uniform mat4 uMVMatrix;
            uniform mat4 uPMatrix;

            varying vec2 vTextureCoord;
            varying vec3 vNormal;

            void main(void) {
                gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
                vTextureCoord = aTextureCoord;
                vNormal = aNormal;
            }
        </script>

        <script id="shader-fs" type="x-shader/x-fragment">
            precision mediump float;

            varying vec2 vTextureCoord;

            uniform sampler2D uSampler0;
            uniform float ambient;
            uniform vec3 lightColor;
            uniform vec3 lightPosition;
            varying vec3 vNormal;

            void main(void) {
                vec4 color = texture2D(uSampler0, vec2(vTextureCoord.s, vTextureCoord.t));
                vec3 nrm = normalize(vNormal);
                vec3 nrmLight = normalize(lightPosition);
                float amount = dot(nrm, nrmLight);
                color.rgb *= ambient;
                vec3 lightAmount = lightColor * amount;
                color.rgb += lightAmount;
                gl_FragColor = color;
            }
        </script>


        <script>
            window.requestAnimFrame = (function(){
                return  window.requestAnimationFrame       || 
                window.webkitRequestAnimationFrame || 
                window.mozRequestAnimationFrame    || 
                window.oRequestAnimationFrame      || 
                window.msRequestAnimationFrame     || 
                function( callback ){
                window.setTimeout(callback, 1000 / 60);
                };
            })();

            function init() {
                console.log( "Init " );
                img = new Image();
                img.onload = function(e) {  _onImageLoaded();   }
                img.src = "images/bg.jpg";
            }


            function _onImageLoaded(e) {
                canvasGL = document.createElement("canvas");
                canvasGL.id = "canvasGL";
                canvasGL.width = window.innerWidth;
                canvasGL.height = window.innerHeight;
                canvasGL.style.position = "absolute";
                canvasGL.style.zIndex = "0";

                gl = canvasGL.getContext("experimental-webgl");
                gl.viewportWidth = window.innerWidth;
                gl.viewportHeight = window.innerHeight;
                document.body.appendChild(canvasGL);

                texture = new GLTexture(gl, img);

                model = new bongiovi.GLModel(gl, 4);
                shader = new bongiovi.GLModelShader(this.gl, "shader-vs", "shader-fs");
                shader.setParameter("ambient", "uniform1f", .2);
                shader.setParameter("lightColor", "uniform3fv", [1, 0, 0]);
                shader.setParameter("lightPosition", "uniform3fv", [1, 0, 1]);
                model.setTexture(0, texture);
                this.model.setAttribute(0, "aNormal", 3);

                var size = 100;
                model.updateVertex(0, -size, -size, 0);
                model.updateVertex(1,  size, -size, 0);
                model.updateVertex(2,  size,  size, 0);
                model.updateVertex(3, -size,  size, 0);

                model.updateTextCoord(0, 0, 0);
                model.updateTextCoord(1, 1, 0);
                model.updateTextCoord(2, 1, 1);
                model.updateTextCoord(3, 0, 1);

                this.model.updateAttribute(0, 0,   [0, 0, 1]);
                this.model.updateAttribute(0, 1,   [0, 0, 1]);
                this.model.updateAttribute(0, 2,   [0, 0, 1]);
                this.model.updateAttribute(0, 3,   [0, 0, 1]);

                model.generateBuffer();

                var W = canvasGL.width;
                var H = canvasGL.height;
                projection = new bongiovi.ProjectionPerspectiveMatrix();
                projection.perspective(45, W/H, .1, 1000);
                camera = new bongiovi.HoverCamera().init(500);

                loop();
            }


            function loop() {
                requestAnimFrame(loop);
                render();
            }


            function render() {
                gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.enable(gl.BLEND);
                gl.enable(gl.DEPTH_TEST);

                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
                model.render(shader, camera.update(), projection.matrix);
            }
        </script>
    
    </head>
        

    <body onload="init()">
        <!-- <div id="map_canvas" style="width:50%; height:100%; z-index:1; position:absolute;"></div> -->
    </body>
</html>